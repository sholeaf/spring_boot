<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>게시글</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</head>

<body>
	<div id="modalContent">
		<div id="contentView">
			<div class="images-container carousel slide" id="carouselExample">
				<div class="carousel-inner">
					<div th:each="img, iterStat : ${flist}"
						th:class="${iterStat.first} ? 'active carousel-item' : 'carousel-item'">
						<img th:src="@{/images/pimages/}+${img}" style="width: auto; max-width: 500px; height: auto;">
					</div>
				</div>

				<button class="carousel-control-prev" type="button" data-bs-target="#carouselExample"
					data-bs-slide="prev">
					<span class="carousel-control-prev-icon" style="background-color: black;" aria-hidden="true"></span>
					<span class="visually-hidden">Previous</span>
				</button>
				<button class="carousel-control-next" type="button" data-bs-target="#carouselExample"
					data-bs-slide="next">
					<span class="carousel-control-next-icon" style="background-color: black;" aria-hidden="true"></span>
					<span class="visually-hidden">Next</span>
				</button>
			</div>
			<input id="boardnum" type="hidden" th:value="${board.boardnum}" />
			<h2 th:text="${board.boardtitle}">제목</h2>
			<p th:text="${board.userid}">작성자</p>
			<p th:text="${board.boardcontents}">내용</p>
			<a href="#" id="viewPostlike">하트
				<p th:text="${board.boardlikecnt}"></p>
			</a>
			<th:block>
				<div th:if="${board.userid == session.loginUser}">
					<a class="modify" href="#">수정</a>
					<a th:href="${'/pboard/remove?boardnum='+board.boardnum}">삭제</a>
				</div>
			</th:block>
			<!-- 댓글은 추후에 -->
		</div>
		<div id="modify" style="display: none;">
			<h2>게시물 수정</h2>
			<form id="modifyForm" method="post" action="/pboard/modify" enctype="multipart/form-data">
				<input type="text" name="boardtitle" th:value="${board.boardtitle}" placeholder="제목"
					required /><br /><br />

				<input type="file" id="newFileInput" name="files" multiple accept=".jpg,.jpeg,.png,.webp,.gif" />
				<button type="button" id="newFileButton">사진 추가하기</button>
				<div id="warningText" style="visibility: hidden;">
					<p>사진을 추가해야 게시글을 작성할 수 있습니다.</p> <!-- 경고 메시지 -->
				</div>

				<!--기존파일 list-->
				<ul class="board-file">
					<li class="del-item" th:each="img:${flist}">
						<div class="thumbnail-container">
							<input type="hidden" class="fpath" th:value="${img}">
							<img th:src="@{/images/pimages/}+${img}" class="thumbnail">
						</div>
						<button>삭제</button>
					</li>
				</ul>


				<ul id="newFileList"></ul> <!--선택된 파일 리스트를 보기 위한 태그-->

				<textarea name="boardcontents" required>[[${board.boardcontents}]]</textarea><br /><br />
				<input type="text" name="userid" th:value="${session.loginUser}" readonly />
				<button type="submit">등록</button>
				<button type="button" id="close">취소</button>
			</form>
		</div>
	</div>
</body>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
	$(document).ready(function () {
		const newFileInput = $('#newFileInput')[0]; // 여기에서 선언
		const newFileList = $('#newFileList');
		let newDataTransfer = new DataTransfer(); // DataTransfer 객체 초기화

		// 수정 버튼 클릭 시 이벤트
		$('.modify').on('click', function (e) {
			e.preventDefault(); // 기본 링크 동작 방지

			// 현재 콘텐츠를 숨기고 수정 폼 표시
			$('#contentView').hide(); // 기존 게시글 내용을 숨김
			$('#modify').show(); // 수정 폼을 보여줌
		});

		// 수정 폼에서 취소 버튼 클릭 시 이벤트
		$('#close').on('click', function () {
			$('#modify').hide(); // 수정 폼 숨김
			$('#contentView').show(); // 기존 콘텐츠 다시 표시
		});

		$('#newFileButton').on('click', function () {
			newFileInput.click(); // 숨겨진 파일 입력 요소 클릭
		});

		// 파일 추가 및 리스트 업데이트
		newFileInput.addEventListener('change', function (event) {
			const selectedFiles = Array.from(event.target.files);
			selectedFiles.forEach(file => {
				// 중복 체크
				if (![...newDataTransfer.files].some(f => f.name === file.name && f.size === file.size)) {
					newDataTransfer.items.add(file); // DataTransfer에 파일 추가
				}
			});
			newFileInput.files = newDataTransfer.files; // input의 파일 리스트 업데이트
			updateNewFileList(); // 파일 리스트 업데이트
			if (newDataTransfer.files.length === 0 && $('.del-item').length === 0) {
				$('#warningText').css('visibility', 'visible'); // 경고 메시지 표시
			}
			else {
				$('#warningText').css('visibility', 'hidden'); // 경고 메시지 표시
			}
		});

		// 파일 리스트 업데이트 함수
		function updateNewFileList() {
			newFileList.empty();
			Array.from(newDataTransfer.files).forEach((file, index) => {
				const li = $('<li>').addClass('file-item');

				// 이미지 파일일 경우 썸네일 생성
				if (file.type.startsWith('image/')) {
					const thumbnailDiv = $('<div>').addClass('thumbnail-container');
					const img = $('<img>').attr('src', URL.createObjectURL(file)).addClass('thumbnail');
					thumbnailDiv.append(img);
					li.prepend(thumbnailDiv);
				}

				const removeBtn = $('<button>').text('삭제').on('click', function () {
					newDataTransfer.items.remove(index); // DataTransfer에서 파일 제거
					newFileInput.files = newDataTransfer.files; // input의 파일 리스트 업데이트
					updateNewFileList(); // 리스트 업데이트
					if (newDataTransfer.files.length === 0 && $('.del-item').length === 0) {
						$('#warningText').css('visibility', 'visible'); // 경고 메시지 표시
					}
					else {
						$('#warningText').css('visibility', 'hidden'); // 경고 메시지 표시
					}
				});
				li.append(removeBtn);
				newFileList.append(li);
			});
		}

		//del-item에서 삭제버튼을 누른 사진의 systemname을 저장하는 배열 선언
		let deletedFiles = [];

		$('.del-item button').on('click', function (e) {
			e.preventDefault();

			const fileName = $(this).closest('.del-item').find('.fpath').val();
			console.log('삭제 파일 이름 : ', fileName);
			deletedFiles.push(fileName);
			$(this).closest('.del-item').remove();
			console.log('deletedFiles : ', deletedFiles);
			if ($('.del-item').length === 0 && newDataTransfer.files.length === 0) {
				$('#warningText').css('visibility', 'visible'); // 경고 메시지 표시
			}
			else {
				$('#warningText').css('visibility', 'hidden'); // 경고 메시지 표시
			}
		});

		$('#modifyForm').on('submit', function (e) {
			e.preventDefault();

			const formData = new FormData(this);
			//보낼 board 관련 데이터 추가
			formData.append('boardnum', $('#boardnum').val());
			formData.append('boardtitle', $('input[name="boardtitle"]').val());
			formData.append('boardcontents', $('textarea[name="boardcontetns"]').val());

			//보낼 file 관련 데이터 추가
			if (deletedFiles != 0 || deletedFiles != null) {
				formData.append('delete', JSON.stringify(deletedFiles));
			}
			if (newDataTransfer.files.length != 0 || newDataTransfer.files.length != null) {
				for (let i = 0; i < newDataTransfer.files.length; i++) {
					formData.append('files', newDataTransfer.files[i]);
					console.log('파일 추가:', newDataTransfer.files[i].name); // 파일 이름 확인
				}
			}
			$.ajax({
				url: '/pboard/modify',
				method: 'POST',
				data: formData,
				contentType: false,
				processData: false,
				success: function (response) {
					// 성공적으로 수정된 후에 페이지를 업데이트
					alert(response); // 서버 응답을 알림으로 표시
					location.href = '/pboard/list';
				},
				error: function () {
					alert('수정에 실패했습니다.');
				}
			});
		});
	});
</script>

</html>